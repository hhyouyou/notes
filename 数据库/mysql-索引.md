[TOC]



# mysql 索引 



## 索引是什么?

### 1. 索引的本质

索引(Index)的本质是一种数据结构.

目的是为了提高查询效率

### 2. 索引的分类

#### 2.1 Hash 索引

主要用于精确查找, 数据库为每列计算hash值, 所以查询比较快.

但是计算出来的hash值是无序的,所以不好做范围查询.

所以这种索引不常用. 常用的`innodb`就不支持hash索引

#### 2.2 B+树

 B树也就是B-树, 又名平衡多路查找树. 对比平衡二叉树,有以下几点不同

1. 平衡二叉树最多只有两个子树, 而B树可以有多个子树, **M阶表示B树表示该树每个节点最多有个M个子树**
2. 平衡二叉树每个节点只有一个数据和两个指向孩子的指针, 而B树每个节点有个`k-1`个数据,和`k`个子树(**k介于阶数M和M/2之间**)
3. B树的所有叶子节点都在同一层.

具体插入删除的过程略.

B+树是B树的一种变形.它的查询性能更高.

1. 关键字数和子树相同（B 树是关键字数比子树数少一）
2. 非叶子节点仅用作索引，它的关键字和子节点有重复元素
3. 叶子节点用指针连在一起

![B+树](http://image-djx.test.upcdn.net/md/notes/%E7%B4%A2%E5%BC%95.png)





#### 2.3 聚簇索引

聚簇索引: 就是索引即数据,索引中包含着整列数据.

mysql, innodb引擎中的主键索引就是. 这也是该引擎的特色, 数据按照主键索引(B+Tree)的方式存储.

#### 2.4 非聚簇索引

非聚簇索引: 索引中只包含索引信息, 不包含整列数据内容.

所以, 在innodb引擎中, 除了主键索引之外的索引, 只保存,索引列值和主键id. 通过索引列找到主键id后,再去回表,根据主键索引查出整列数据.

当然,如果只是需要索引字段,那么是可以不用回表的.

## 索引优化

### 建索引注意事项

1. 为频繁查询字段简历索引
2. 避免为"大字段"建立索引
3. 选择区分度大的列作为索引
4. 不要建立太多索引
5. 频繁增删改的字段不要建立索引

### 索引失效常见场景

1. 使用`or`关键字,会导致索引失效,不过如果`or`条件中每个列都有索引也能正常使用. 不过这个索引就建立太多了
2. 联合索引如果不遵循最左前缀原则,那么索引也将失效
3. 使用模糊查询时,以`%`开头也会导致索引失效.
4. 索引列如果使用了隐使转换也会导致失效
5. 对索引列使用函数,或者参与计算. 也会导致索引失效

### 慢查询优化

1. 找到对应`sql`, 关闭缓存设置后(`SQL_NO_CACHE`).在对应环境跑一下,看看是否真的很慢
2. where条件单表查，锁定最小返回记录表。这句话的意思是把查询语句的where都应用到表中返回的记录数最小的表开始查起，单表每个字段分别查询，看哪个字段的区分度最高.
3. explain查看执行计划，是否与上一步预期一致（从锁定记录较少的表开始查询）
4. order by limit 形式的语句让排序的表优先查(放到前面查)
5. 了解业务的使用场景, 看能否在内存中拆分查多次
6. 加索引时参照建索引的几大原则



## 参考文章

1. [B树 B+树](https://juejin.cn/post/6844903944292925447)
2. [数据库问答](https://juejin.cn/post/6844903885501530125)
3. [重温数据结构：理解 B 树、B+ 树特点及使用场景](https://juejin.cn/post/6844903613915987975)
4. [MySQL索引和SQL调优](https://juejin.cn/post/6844903555141206030)
5. [关于mysql索引的原理](https://www.hollischuang.com/archives/6172)

